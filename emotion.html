<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ§ æ°¸é ç›£è½èªéŸ³æƒ…ç·’åˆ†æç³»çµ± (ç©©å®šç‰ˆ)</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      text-align: center;
      margin-top: 40px;
      background: #fafafa;
    }
    input, button {
      padding: 8px;
      margin: 5px;
      width: 280px;
      font-size: 16px;
    }
    #status { margin-top: 20px; font-size: 18px; color: #333; }
    #emotionLight {
      width: 90px; height: 90px;
      border-radius: 50%;
      margin: 20px auto;
      background: gray;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      transition: background 0.4s, box-shadow 0.4s;
    }
    #logContainer {
      width: 85%;
      max-width: 700px;
      margin: 20px auto;
      text-align: left;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 10px 15px;
      font-size: 15px;
      overflow-y: auto;
      max-height: 350px;
    }
    .logItem { border-bottom: 1px solid #ddd; padding: 8px 0; }
    .emotionTag { font-weight: bold; margin-right: 6px; }
    .userText { color: #000; font-style: italic; margin: 5px 0; display: block; }
    .adviceText { color: #d33; margin-top: 3px; display: block; }
  </style>
</head>
<body>
  <h2>ğŸ¤– æ°¸é ç›£è½èªéŸ³æƒ…ç·’åˆ†æ</h2>
  <input id="webhookUrl" placeholder="n8n Webhook URL" /><br>
  <button id="startBtn">ğŸš€ é–‹å§‹ç›£è½</button>
  <button id="stopBtn">ğŸ›‘ åœæ­¢ç›£è½</button>

  <div id="emotionLight"></div>
  <p id="status">å°šæœªå•Ÿå‹•</p>

  <div id="logContainer"></div>

  <script>
    let n8nUrl = "";
    let audioCtx, analyser, micStream;
    let mediaRecorder;
    let audioChunks = [];
    let running = false;
    let isUploading = false;
    let logs = [];

    // ğŸŸ¢ å•Ÿå‹•ç›£è½
    async function startListening() {
      n8nUrl = document.getElementById("webhookUrl").value.trim();
      if (!n8nUrl) return alert("è«‹è¼¸å…¥ n8n Webhook URLï¼");
      running = true;
      document.getElementById("status").innerText = "ğŸ§ éº¥å…‹é¢¨ç›£è½ä¸­...";
      await initMic();
      detectSilenceLoop();
    }

    // ğŸ”´ åœæ­¢ç›£è½
    function stopListening() {
      running = false;
      if (micStream) micStream.getTracks().forEach(t => t.stop());
      if (audioCtx) audioCtx.close();
      document.getElementById("status").innerText = "ğŸ›‘ å·²åœæ­¢ç›£è½";
      showEmotion("ä¸­ç«‹");
    }

    // ğŸ¤ åˆå§‹åŒ–éº¥å…‹é¢¨
    async function initMic() {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioCtx = new AudioContext();
      const source = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
    }

    // ğŸ” åµæ¸¬éŸ³é‡è®ŠåŒ–
    async function detectSilenceLoop() {
      const buffer = new Uint8Array(analyser.fftSize);
      let lastVoice = 0;
      let recording = false;

      const loop = async () => {
        if (!running) return;
        analyser.getByteTimeDomainData(buffer);
        const max = Math.max(...buffer.map(v => Math.abs(v - 128)));
        const now = audioCtx.currentTime;

        if (max > 30) { // â† æé«˜é–¾å€¼é¿å…å‘¼å¸è²èª¤è§¸
          if (!recording && !isUploading) {
            console.log("ğŸ—£ï¸ åµæ¸¬åˆ°äººè²ï¼Œé–‹å§‹éŒ„éŸ³");
            startRecording();
            recording = true;
          }
          lastVoice = now;
        } else if (recording && now - lastVoice > 2) { // â† æ”¹ 2 ç§’éœéŸ³çµæŸ
          console.log("ğŸ›‘ åµæ¸¬åˆ°éœéŸ³ï¼Œè‡ªå‹•çµæŸéŒ„éŸ³");
          stopRecording();
          recording = false;
        }

        requestAnimationFrame(loop);
      };
      loop();
    }

    // ğŸ™ï¸ éŒ„éŸ³é–‹å§‹
    async function startRecording() {
      audioChunks = [];
      mediaRecorder = new MediaRecorder(micStream);
      mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
      mediaRecorder.onstop = sendToN8n;
      mediaRecorder.start();
      document.getElementById("status").innerText = "ğŸ™ï¸ éŒ„éŸ³ä¸­...";
    }

    // â¹ï¸ éŒ„éŸ³çµæŸ
    async function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        document.getElementById("status").innerText = "ğŸ“¤ å‚³é€éŒ„éŸ³ä¸­...";
      }
    }

    // ğŸ“¡ å‚³é€åˆ° n8n
    async function sendToN8n() {
      if (isUploading) {
        console.warn("âš ï¸ ä¸Šæ¬¡ä¸Šå‚³æœªå®Œæˆï¼Œè·³éé€™æ¬¡ã€‚");
        return;
      }
      isUploading = true;

      const blob = new Blob(audioChunks, { type: "audio/webm" });
      if (blob.size < 5000) { // â† å°æ–¼5KBç•¶é›œéŸ³å¿½ç•¥
        console.log("ğŸ”‡ éŸ³è¨Šå¤ªçŸ­ï¼Œç•¥éã€‚");
        isUploading = false;
        return;
      }

      const formData = new FormData();
      formData.append("audio_file", blob, "voice.webm");

      try {
        const res = await fetch(n8nUrl, { method: "POST", body: formData });
        const textRes = await res.text();
        let result = null;

        try {
          result = JSON.parse(textRes);
        } catch {
          console.warn("âš ï¸ å›å‚³ä¸æ˜¯åˆæ³• JSONï¼š", textRes);
        }

        if (result) {
          showEmotion(result.emotion);
          document.getElementById("status").innerText =
            `ğŸ§  ${result.emotion} ï½œ ${result.tone || ""}`;
          addLog(result);
        } else {
          console.warn("âš ï¸ æœªæ”¶åˆ°æ­£ç¢ºè³‡æ–™");
        }
      } catch (err) {
        console.error("âŒ å‚³é€æˆ–åˆ†æå¤±æ•—ï¼š", err);
        document.getElementById("status").innerText = "âŒ ä¸Šå‚³å¤±æ•—";
      } finally {
        isUploading = false;
        if (running) detectSilenceLoop();
      }
    }

    // ğŸ’¡ é¡¯ç¤ºæƒ…ç·’ç‡ˆè™Ÿ
    function showEmotion(emotion) {
      const light = document.getElementById("emotionLight");
      const map = {
        "å¹³éœ": "green",
        "ä¸­ç«‹": "green",
        "è«·åˆº": "yellow",
        "ç”Ÿæ°£": "red",
        "æ‚²å‚·": "blue",
        "é«˜èˆˆ": "orange",
        "ä¸è€ç…©": "purple"
      };
      const color = map[emotion] || "gray";
      light.style.background = color;
      light.style.boxShadow = `0 0 25px ${color}`;
    }

    // ğŸ“‹ æ–°å¢ç´€éŒ„
    function addLog(result) {
      const container = document.getElementById("logContainer");
      const log = {
        time: new Date().toLocaleTimeString(),
        text: result.text || "ï¼ˆæœªå–å¾—æ–‡å­—ï¼‰",
        emotion: result.emotion || "æœªçŸ¥",
        tone: result.tone || "",
        advice: result.advice || ""
      };
      logs.unshift(log);
      if (logs.length > 5) logs.pop();

      container.innerHTML = logs.map(l => `
        <div class="logItem">
          <span class="emotionTag">ğŸ•’ ${l.time}</span><br>
          <span class="userText">ğŸ—£ï¸ ä½ èªªï¼šã€Œ${l.text}ã€</span>
          <span>ğŸ’­ æƒ…ç·’ï¼š<b>${l.emotion}</b> (${l.tone})</span><br>
          <span class="adviceText">ğŸ’¡ ${l.advice}</span>
        </div>
      `).join("");
    }

    // ğŸ”— ç¶å®šæŒ‰éˆ•
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("startBtn").addEventListener("click", startListening);
      document.getElementById("stopBtn").addEventListener("click", stopListening);
    });
  </script>
</body>
</html>
