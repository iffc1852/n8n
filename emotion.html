<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ§ èªéŸ³æƒ…ç·’ç›£è½ï¼ˆå¯ä¸‹è¼‰å®Œæ•´æ–‡å­—ï¼‰</title>
  <style>
    body { font-family:"Microsoft JhengHei",sans-serif;text-align:center;margin:28px auto;background:#fafafa;}
    input,button{padding:8px;margin:5px;width:280px;font-size:16px;}
    #status{margin-top:8px;font-size:16px;color:#333;min-height:24px;}
    #emotionLight{width:90px;height:90px;border-radius:50%;margin:14px auto 8px;
      background:gray;box-shadow:0 0 18px rgba(0,0,0,0.25);transition:background .25s,box-shadow .25s;}
    #logContainer{width:90%;max-width:760px;margin:16px auto;text-align:left;
      background:#fff;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.08);
      padding:12px 14px;font-size:15px;}
    .logItem{border-bottom:1px solid #eee;padding:8px 2px;}
    .logItem:last-child{border-bottom:none;}
    .userText{color:#000;font-style:italic;margin:4px 0 6px;display:block;}
    .adviceText{color:#c0392b;margin-top:3px;display:block;}
  </style>
</head>
<body>
  <h2>ğŸ¤– èªéŸ³æƒ…ç·’ç›£è½ç³»çµ±</h2>
  <input id="webhookUrl" placeholder="n8n Webhook URL"/><br>
  <div>
    <button id="startBtn">ğŸš€ é–‹å§‹ç›£è½</button>
    <button id="stopBtn">ğŸ›‘ åœæ­¢ç›£è½</button>
    <button id="downloadBtn">ğŸ“„ ä¸‹è¼‰å…¨éƒ¨æ–‡å­—</button>
  </div>

  <div id="emotionLight"></div>
  <div id="status">å°šæœªå•Ÿå‹•</div>
  <div id="logContainer"></div>

  <script>
    let n8nUrl="",audioCtx,analyser,micStream,mediaRecorder;
    let audioChunks=[],running=false,isUploading=false,isRecording=false;
    let cooldownUntil=0,silenceStopper=null,recordStartTime=0;
    const logs=[],allLogs=[];
    const $status=document.getElementById("status"),$log=document.getElementById("logContainer");
    const EMO_COLORS={
      "é«˜èˆˆ":"#FFC107","æ‚²å‚·":"#1E90FF","ç”Ÿæ°£":"#FF3B30","ä¸è€ç…©":"#8E44AD",
      "è«·åˆº":"#FF8C00","å¹³éœ":"#2ECC71","ä¸­ç«‹":"#27AE60"};

    window.addEventListener("DOMContentLoaded",()=>{
      document.getElementById("startBtn").addEventListener("click",startListening);
      document.getElementById("stopBtn").addEventListener("click",stopListening);
      document.getElementById("downloadBtn").addEventListener("click",downloadAll);
    });

    async function startListening(){
      if(running)return;
      n8nUrl=document.getElementById("webhookUrl").value.trim();
      if(!n8nUrl)return alert("è«‹è¼¸å…¥ n8n Webhook URLï¼");
      try{
        await initMic();
        running=true;
        $status.textContent="ğŸ§ éº¥å…‹é¢¨ç›£è½ä¸­...";
        startSilenceDetect();
      }catch(e){$status.textContent="âŒ ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨ï¼š"+e?.message;}
    }

    async function stopListening(){
      cooldownUntil=performance.now()+1200;
      running=false;
      if(silenceStopper)silenceStopper(),silenceStopper=null;
      if(mediaRecorder&&mediaRecorder.state==="recording")try{mediaRecorder.stop();}catch{}
      if(micStream){micStream.getTracks().forEach(t=>t.stop());micStream=null;}
      if(audioCtx&&audioCtx.state!=="closed"){try{await audioCtx.close();}catch{}audioCtx=null;}
      isRecording=false;$status.textContent="ğŸ›‘ å·²åœæ­¢ç›£è½";showEmotion("ä¸­ç«‹");
    }

    async function initMic(){
      micStream=await navigator.mediaDevices.getUserMedia({
        audio:{channelCount:1,sampleRate:48000,noiseSuppression:true,echoCancellation:true,autoGainControl:true}});
      audioCtx=new(window.AudioContext||window.webkitAudioContext)();
      const source=audioCtx.createMediaStreamSource(micStream);
      analyser=audioCtx.createAnalyser();analyser.fftSize=2048;source.connect(analyser);
    }

    function startSilenceDetect(){
      const buffer=new Uint8Array(analyser.fftSize);
      let lastVoiceTime=0,rafId=0,stopped=false;
      const VOICE_THRESHOLD=45,SILENCE_SEC=2.5,MIN_MS=1200,MIN_SIZE=12000;
      function startRecording(){
        if(isRecording||isUploading)return;
        audioChunks=[];mediaRecorder=new MediaRecorder(micStream);
        mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data);};
        mediaRecorder.onstop=()=>uploadIfValid(MIN_MS,MIN_SIZE);
        recordStartTime=performance.now();mediaRecorder.start();
        isRecording=true;$status.textContent="ğŸ™ï¸ éŒ„éŸ³ä¸­...";
      }
      async function stopRecording(){
        if(!isRecording)return;
        try{mediaRecorder.stop();$status.textContent="ğŸ“¤ å‚³é€éŒ„éŸ³ä¸­...";}catch{}
        isRecording=false;
      }
      async function uploadIfValid(minDur,minSize){
        if(!running&&performance.now()<cooldownUntil)return;
        const dur=performance.now()-recordStartTime;
        const blob=new Blob(audioChunks,{type:"audio/webm"});
        if(dur<minDur||blob.size<minSize){if(running&&!stopped)loop();return;}
        await sendToN8n(blob);if(running&&!stopped)loop();
      }
      function loop(){
        if(stopped||!running)return;
        analyser.getByteTimeDomainData(buffer);
        const now=audioCtx.currentTime;
        let max=0;for(let i=0;i<buffer.length;i++){const a=Math.abs(buffer[i]-128);if(a>max)max=a;}
        if(max>VOICE_THRESHOLD&&performance.now()>cooldownUntil){
          lastVoiceTime=now;if(!isRecording&&!isUploading)startRecording();
        }else if(isRecording){
          const silentFor=now-lastVoiceTime;
          if(silentFor>=SILENCE_SEC+0.3)stopRecording();
        }
        rafId=requestAnimationFrame(loop);
      }
      loop();silenceStopper=()=>{stopped=true;if(rafId)cancelAnimationFrame(rafId);};
    }

    async function sendToN8n(blob){
      if(isUploading)return;isUploading=true;
      try{
        const formData=new FormData();formData.append("audio_file",blob,"voice.webm");
        const res=await fetch(n8nUrl,{method:"POST",body:formData});
        const raw=await res.text();let result=null;try{result=JSON.parse(raw);}catch{}
        if(result){
          showEmotion(result.emotion);
          addLog({text:result.text||"ï¼ˆæœªå–å¾—æ–‡å­—ï¼‰",emotion:result.emotion||"æœªçŸ¥",
                  tone:result.tone||"",advice:result.advice||""});
          $status.textContent=`ğŸ§  ${result.emotion||"æœªçŸ¥"}ï½œ${result.tone||""}`;
        }else{$status.textContent="âš ï¸ æœªæ”¶åˆ°æœ‰æ•ˆçµæœ";}
      }catch(e){console.error("âŒ ä¸Šå‚³å¤±æ•—",e);$status.textContent="âŒ ä¸Šå‚³å¤±æ•—";}
      finally{isUploading=false;}
    }

    function showEmotion(emotion){
      const light=document.getElementById("emotionLight");
      const color=EMO_COLORS[emotion]||"gray";
      light.style.background=color;light.style.boxShadow=`0 0 25px ${color}`;
    }

    function addLog(entry){
      const record={time:new Date().toLocaleTimeString(),...entry};
      logs.unshift(record);allLogs.push(record);
      if(logs.length>10)logs.pop();
      $log.innerHTML=logs.map(l=>`
        <div class="logItem">
          <div>ğŸ•’ ${l.time}</div>
          <span class="userText">ğŸ—£ï¸ ä½ èªªï¼šã€Œ${escapeHtml(l.text)}ã€</span>
          <div>ğŸ’­ æƒ…ç·’ï¼š<b>${l.emotion}</b>ã€€<span>${l.tone}</span></div>
          <span class="adviceText">${escapeHtml(l.advice)}</span>
        </div>`).join("");
    }

    function escapeHtml(str){
      return String(str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    // ===== ä¸‹è¼‰å…¨éƒ¨æ–‡å­— =====
    function downloadAll(){
      if(allLogs.length===0){alert("ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚");return;}
      const content=allLogs.map(l=>
        `ğŸ•’ ${l.time}\nğŸ—£ï¸ ä½ èªªï¼šã€Œ${l.text}ã€\nğŸ’­ æƒ…ç·’ï¼š${l.emotion}\nğŸ§ èªæ°£ï¼š${l.tone}\nğŸ’¡ å»ºè­°ï¼š${l.advice}\n\n`
      ).join("");
      const blob=new Blob([content],{type:"text/plain;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      const now=new Date().toLocaleString("zh-TW").replace(/[\/\s:]/g,"-");
      a.download=`èªéŸ³ç´€éŒ„_${now}.txt`;a.click();URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
