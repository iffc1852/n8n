<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>🎧 永遠監聽語音情緒分析系統 (含紀錄+文字顯示)</title>
  <style>
    body { 
      font-family: "Microsoft JhengHei", sans-serif; 
      text-align: center; 
      margin-top: 40px; 
      background: #fafafa;
    }
    input, button { 
      padding: 8px; 
      margin: 5px; 
      width: 280px; 
      font-size: 16px; 
    }
    #status { margin-top: 20px; font-size: 18px; color: #333; }
    #emotionLight {
      width: 90px; height: 90px;
      border-radius: 50%;
      margin: 20px auto;
      background: gray;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      transition: background 0.4s, box-shadow 0.4s;
    }
    #logContainer {
      width: 85%;
      max-width: 700px;
      margin: 20px auto;
      text-align: left;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 10px 15px;
      font-size: 15px;
      overflow-y: auto;
      max-height: 350px;
    }
    .logItem {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
    }
    .emotionTag { font-weight: bold; margin-right: 6px; }
    .userText { color: #000; font-style: italic; margin: 5px 0; display: block; }
    .adviceText { color: #d33; margin-top: 3px; display: block; }
  </style>
</head>
<body>
  <h2>🤖 永遠監聽語音情緒分析</h2>
  <input id="webhookUrl" placeholder="n8n Webhook URL" /><br>
  <button id="startBtn">🚀 開始監聽</button>
  <button id="stopBtn">🛑 停止監聽</button>

  <div id="emotionLight"></div>
  <p id="status">尚未啟動</p>

  <div id="logContainer"></div>

  <script>
    let n8nUrl = "";
    let audioCtx, analyser, micStream;
    let mediaRecorder;
    let audioChunks = [];
    let running = false;
    let logs = []; // 儲存最新五次紀錄

    // 啟動監聽
    async function startListening() {
      n8nUrl = document.getElementById("webhookUrl").value.trim();
      if (!n8nUrl) return alert("請輸入 n8n Webhook URL！");
      running = true;
      document.getElementById("status").innerText = "🎧 麥克風監聽中...";
      await initMic();
      detectSilenceLoop();
    }

    // 停止監聽
    function stopListening() {
      running = false;
      if (micStream) micStream.getTracks().forEach(t => t.stop());
      if (audioCtx) audioCtx.close();
      document.getElementById("status").innerText = "🛑 已停止監聽";
      showEmotion("中立");
    }

    // 初始化麥克風
    async function initMic() {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioCtx = new AudioContext();
      const source = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
    }

    // 持續偵測音量變化
    async function detectSilenceLoop() {
      const buffer = new Uint8Array(analyser.fftSize);
      let lastVoice = 0;
      let recording = false;

      const loop = async () => {
        if (!running) return;
        analyser.getByteTimeDomainData(buffer);
        const max = Math.max(...buffer.map(v => Math.abs(v - 128)));

        const now = audioCtx.currentTime;
        if (max > 15) {
          if (!recording) {
            console.log("🗣️ 偵測到人聲，開始錄音");
            startRecording();
            recording = true;
          }
          lastVoice = now;
        } else if (recording && now - lastVoice > 3) {
          console.log("🛑 3 秒無聲，自動結束錄音");
          stopRecording();
          recording = false;
        }
        requestAnimationFrame(loop);
      };
      loop();
    }

    // 錄音開始
    async function startRecording() {
      audioChunks = [];
      mediaRecorder = new MediaRecorder(micStream);
      mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
      mediaRecorder.onstop = sendToN8n;
      mediaRecorder.start();
      document.getElementById("status").innerText = "🎙️ 錄音中...";
    }

    // 錄音結束後上傳
    async function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        document.getElementById("status").innerText = "📤 傳送錄音中...";
      }
    }

    // 上傳至 n8n
    async function sendToN8n() {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      const formData = new FormData();
      formData.append("audio_file", blob, "voice.webm");

      try {
        const res = await fetch(n8nUrl, { method: "POST", body: formData });
        const contentType = res.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
          const result = await res.json();
          console.log("📊 收到分析結果：", result);
          showEmotion(result.emotion);
          document.getElementById("status").innerText =
            `🧠 ${result.emotion} ｜ ${result.tone || ""}`;
          addLog(result);
        } else {
          console.warn("⚠️ 未收到 JSON 格式回覆");
          showEmotion("中立");
        }
      } catch (err) {
        console.error("❌ 上傳或分析發生錯誤：", err);
        document.getElementById("status").innerText = "❌ 傳送失敗";
        showEmotion("中立");
      } finally {
        if (running) detectSilenceLoop(); // 持續循環
      }
    }

    // 顯示情緒燈號
    function showEmotion(emotion) {
      const light = document.getElementById("emotionLight");
      const map = {
        "平靜": "green",
        "中立": "green",
        "諷刺": "yellow",
        "生氣": "red",
        "悲傷": "blue",
        "高興": "orange",
        "不耐煩": "purple"
      };
      const color = map[emotion] || "gray";
      light.style.background = color;
      light.style.boxShadow = `0 0 25px ${color}`;
    }

    // 新增歷史紀錄
    function addLog(result) {
      const container = document.getElementById("logContainer");
      const log = {
        time: new Date().toLocaleTimeString(),
        text: result.text || "（未取得文字）",
        emotion: result.emotion || "未知",
        tone: result.tone || "",
        advice: result.advice || ""
      };
      logs.unshift(log);
      if (logs.length > 5) logs.pop();

      container.innerHTML = logs.map(l => `
        <div class="logItem">
          <span class="emotionTag">🕒 ${l.time}</span><br>
          <span class="userText">🗣️ 你說：「${l.text}」</span>
          <span>💭 情緒：<b>${l.emotion}</b> (${l.tone})</span><br>
          <span class="adviceText">💡 ${l.advice}</span>
        </div>
      `).join("");
    }

    // 綁定按鈕
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("startBtn").addEventListener("click", startListening);
      document.getElementById("stopBtn").addEventListener("click", stopListening);
    });
  </script>
</body>
</html>
