<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>🎧 語音情緒監聽（可下載完整文字）</title>
  <style>
    body { font-family:"Microsoft JhengHei",sans-serif;text-align:center;margin:28px auto;background:#fafafa;}
    input,button{padding:8px;margin:5px;width:280px;font-size:16px;}
    #status{margin-top:8px;font-size:16px;color:#333;min-height:24px;}
    #emotionLight{width:90px;height:90px;border-radius:50%;margin:14px auto 8px;
      background:gray;box-shadow:0 0 18px rgba(0,0,0,0.25);transition:background .25s,box-shadow .25s;}
    #logContainer{width:90%;max-width:760px;margin:16px auto;text-align:left;
      background:#fff;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.08);
      padding:12px 14px;font-size:15px;}
    .logItem{border-bottom:1px solid #eee;padding:8px 2px;}
    .logItem:last-child{border-bottom:none;}
    .userText{color:#000;font-style:italic;margin:4px 0 6px;display:block;}
    .adviceText{color:#c0392b;margin-top:3px;display:block;}
  </style>
</head>
<body>
  <h2>🤖 語音情緒監聽系統</h2>
  <input id="webhookUrl" placeholder="n8n Webhook URL"/><br>
  <div>
    <button id="startBtn">🚀 開始監聽</button>
    <button id="stopBtn">🛑 停止監聽</button>
    <button id="downloadBtn">📄 下載全部文字</button>
  </div>

  <div id="emotionLight"></div>
  <div id="status">尚未啟動</div>
  <div id="logContainer"></div>

  <script>
    let n8nUrl="",audioCtx,analyser,micStream,mediaRecorder;
    let audioChunks=[],running=false,isUploading=false,isRecording=false;
    let cooldownUntil=0,silenceStopper=null,recordStartTime=0;
    const logs=[],allLogs=[];
    const $status=document.getElementById("status"),$log=document.getElementById("logContainer");
    const EMO_COLORS={
      "高興":"#FFC107","悲傷":"#1E90FF","生氣":"#FF3B30","不耐煩":"#8E44AD",
      "諷刺":"#FF8C00","平靜":"#2ECC71","中立":"#27AE60"};

    window.addEventListener("DOMContentLoaded",()=>{
      document.getElementById("startBtn").addEventListener("click",startListening);
      document.getElementById("stopBtn").addEventListener("click",stopListening);
      document.getElementById("downloadBtn").addEventListener("click",downloadAll);
    });

    async function startListening(){
      if(running)return;
      n8nUrl=document.getElementById("webhookUrl").value.trim();
      if(!n8nUrl)return alert("請輸入 n8n Webhook URL！");
      try{
        await initMic();
        running=true;
        $status.textContent="🎧 麥克風監聽中...";
        startSilenceDetect();
      }catch(e){$status.textContent="❌ 無法啟用麥克風："+e?.message;}
    }

    async function stopListening(){
      cooldownUntil=performance.now()+1200;
      running=false;
      if(silenceStopper)silenceStopper(),silenceStopper=null;
      if(mediaRecorder&&mediaRecorder.state==="recording")try{mediaRecorder.stop();}catch{}
      if(micStream){micStream.getTracks().forEach(t=>t.stop());micStream=null;}
      if(audioCtx&&audioCtx.state!=="closed"){try{await audioCtx.close();}catch{}audioCtx=null;}
      isRecording=false;$status.textContent="🛑 已停止監聽";showEmotion("中立");
    }

    async function initMic(){
      micStream=await navigator.mediaDevices.getUserMedia({
        audio:{channelCount:1,sampleRate:48000,noiseSuppression:true,echoCancellation:true,autoGainControl:true}});
      audioCtx=new(window.AudioContext||window.webkitAudioContext)();
      const source=audioCtx.createMediaStreamSource(micStream);
      analyser=audioCtx.createAnalyser();analyser.fftSize=2048;source.connect(analyser);
    }

    function startSilenceDetect(){
      const buffer=new Uint8Array(analyser.fftSize);
      let lastVoiceTime=0,rafId=0,stopped=false;
      const VOICE_THRESHOLD=45,SILENCE_SEC=2.5,MIN_MS=1200,MIN_SIZE=12000;
      function startRecording(){
        if(isRecording||isUploading)return;
        audioChunks=[];mediaRecorder=new MediaRecorder(micStream);
        mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data);};
        mediaRecorder.onstop=()=>uploadIfValid(MIN_MS,MIN_SIZE);
        recordStartTime=performance.now();mediaRecorder.start();
        isRecording=true;$status.textContent="🎙️ 錄音中...";
      }
      async function stopRecording(){
        if(!isRecording)return;
        try{mediaRecorder.stop();$status.textContent="📤 傳送錄音中...";}catch{}
        isRecording=false;
      }
      async function uploadIfValid(minDur,minSize){
        if(!running&&performance.now()<cooldownUntil)return;
        const dur=performance.now()-recordStartTime;
        const blob=new Blob(audioChunks,{type:"audio/webm"});
        if(dur<minDur||blob.size<minSize){if(running&&!stopped)loop();return;}
        await sendToN8n(blob);if(running&&!stopped)loop();
      }
      function loop(){
        if(stopped||!running)return;
        analyser.getByteTimeDomainData(buffer);
        const now=audioCtx.currentTime;
        let max=0;for(let i=0;i<buffer.length;i++){const a=Math.abs(buffer[i]-128);if(a>max)max=a;}
        if(max>VOICE_THRESHOLD&&performance.now()>cooldownUntil){
          lastVoiceTime=now;if(!isRecording&&!isUploading)startRecording();
        }else if(isRecording){
          const silentFor=now-lastVoiceTime;
          if(silentFor>=SILENCE_SEC+0.3)stopRecording();
        }
        rafId=requestAnimationFrame(loop);
      }
      loop();silenceStopper=()=>{stopped=true;if(rafId)cancelAnimationFrame(rafId);};
    }

    async function sendToN8n(blob){
      if(isUploading)return;isUploading=true;
      try{
        const formData=new FormData();formData.append("audio_file",blob,"voice.webm");
        const res=await fetch(n8nUrl,{method:"POST",body:formData});
        const raw=await res.text();let result=null;try{result=JSON.parse(raw);}catch{}
        if(result){
          showEmotion(result.emotion);
          addLog({text:result.text||"（未取得文字）",emotion:result.emotion||"未知",
                  tone:result.tone||"",advice:result.advice||""});
          $status.textContent=`🧠 ${result.emotion||"未知"}｜${result.tone||""}`;
        }else{$status.textContent="⚠️ 未收到有效結果";}
      }catch(e){console.error("❌ 上傳失敗",e);$status.textContent="❌ 上傳失敗";}
      finally{isUploading=false;}
    }

    function showEmotion(emotion){
      const light=document.getElementById("emotionLight");
      const color=EMO_COLORS[emotion]||"gray";
      light.style.background=color;light.style.boxShadow=`0 0 25px ${color}`;
    }

    function addLog(entry){
      const record={time:new Date().toLocaleTimeString(),...entry};
      logs.unshift(record);allLogs.push(record);
      if(logs.length>10)logs.pop();
      $log.innerHTML=logs.map(l=>`
        <div class="logItem">
          <div>🕒 ${l.time}</div>
          <span class="userText">🗣️ 你說：「${escapeHtml(l.text)}」</span>
          <div>💭 情緒：<b>${l.emotion}</b>　<span>${l.tone}</span></div>
          <span class="adviceText">${escapeHtml(l.advice)}</span>
        </div>`).join("");
    }

    function escapeHtml(str){
      return String(str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    // ===== 下載全部文字 =====
    function downloadAll(){
      if(allLogs.length===0){alert("目前沒有任何紀錄。");return;}
      const content=allLogs.map(l=>
        `🕒 ${l.time}\n🗣️ 你說：「${l.text}」\n💭 情緒：${l.emotion}\n🎧 語氣：${l.tone}\n💡 建議：${l.advice}\n\n`
      ).join("");
      const blob=new Blob([content],{type:"text/plain;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      const now=new Date().toLocaleString("zh-TW").replace(/[\/\s:]/g,"-");
      a.download=`語音紀錄_${now}.txt`;a.click();URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
