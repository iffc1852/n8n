<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>語音互動 AI 助理</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    input { padding: 8px; margin: 5px; width: 250px; }
    button { padding: 10px 20px; margin-top: 10px; cursor: pointer; }
    #status { margin-top: 20px; font-size: 18px; color: #333; }
  </style>
</head>
<body>
  <h2>🤖 語音互動 AI 助理</h2>
  <p>輸入你的 AI 名稱與 n8n Webhook 網址：</p>
  <input id="aiName" placeholder="AI 名稱 (例如 小智)" /><br>
  <input id="webhookUrl" placeholder="n8n Webhook URL" /><br>
  <button id="startBtn">啟動語音監聽</button>
  <p id="status">尚未啟動</p>

  <script>
    let aiName = "";
    let n8nUrl = "";
    let rec;
    let mediaRecorder;
    let audioChunks = [];
    let audioContext, analyser, source;
    let silenceTimer = null;
    let isRecording = false;

    document.getElementById("startBtn").addEventListener("click", async () => {
      aiName = document.getElementById("aiName").value.trim();
      n8nUrl = document.getElementById("webhookUrl").value.trim();
      if (!aiName || !n8nUrl) {
        alert("請輸入 AI 名稱與 Webhook URL！");
        return;
      }

      document.getElementById("status").innerText = "🎤 正在初始化麥克風...";
      try {
        // ✅ 先請求麥克風權限
        await navigator.mediaDevices.getUserMedia({ audio: true });
        startWakeListener(); // 啟動喚醒
      } catch (err) {
        alert("請允許麥克風權限：" + err.message);
      }
    });

    // ===== [1] 語音喚醒 =====
    function startWakeListener() {
      try {
        if (rec) rec.abort();
        rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.lang = "zh-TW";
        rec.continuous = true;
        rec.interimResults = false;

        rec.onstart = () => {
          document.getElementById("status").innerText = "🎧 已啟動語音喚醒（說出 AI 名稱以開始錄音）";
        };

        rec.onresult = (event) => {
          const transcript = event.results[event.results.length - 1][0].transcript.trim();
          console.log("聽到:", transcript);
          if (transcript.includes(aiName)) {
            document.getElementById("status").innerText = `✅ 偵測到喚醒詞「${aiName}」，開始錄音！`;
            rec.stop();
            startMainRecording();
          }
        };

        rec.onerror = (err) => {
          console.warn("SpeechRecognition 錯誤:", err);
          if (!isRecording) setTimeout(() => rec.start(), 1500);
        };

        rec.onend = () => {
          if (!isRecording) {
            console.log("語音監聽結束，自動重啟...");
            setTimeout(() => rec.start(), 1000);
          }
        };

        rec.start();
      } catch (err) {
        alert("SpeechRecognition 初始化失敗：" + err.message);
      }
    }

    // ===== [2] 錄音階段 =====
    async function startMainRecording() {
      isRecording = true;
      try {
        // 關閉 SpeechRecognition
        if (rec && rec.stop) try { rec.stop(); } catch {}

        await new Promise(r => setTimeout(r, 500)); // 等麥克風釋放

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm;codecs=opus" });
        audioChunks = [];

        audioContext = new AudioContext();
        source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        source.connect(analyser);

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
          isRecording = false;
          const blob = new Blob(audioChunks, { type: "audio/webm" });
          console.log("錄音檔案大小:", blob.size, "bytes");

          if (blob.size < 2000) {
            document.getElementById("status").innerText = "⚠️ 沒有錄到有效聲音，回到監聽...";
            startWakeListener();
            return;
          }

          const formData = new FormData();
          formData.append("file", blob, "voice.webm");

          document.getElementById("status").innerText = "📤 上傳錄音中...";
          try {
            const res = await fetch(n8nUrl, { method: "POST", body: formData });
            const result = await res.json();
            console.log("伺服器回傳:", result);

            if (result.success && result.audio) {
              const audio = new Audio("data:audio/mp3;base64," + result.audio);
              audio.play().catch(err => console.warn("播放被封鎖:", err));
              document.getElementById("status").innerText = "🔊 播放 AI 回覆中...";
              audio.onended = () => {
                document.getElementById("status").innerText = "🎤 等待下一次喚醒...";
                startWakeListener();
              };
            } else {
              document.getElementById("status").innerText = "⚠️ 回傳資料錯誤，回到監聽模式";
              startWakeListener();
            }
          } catch (err) {
            console.error("上傳失敗:", err);
            document.getElementById("status").innerText = "❌ 上傳失敗，重新監聽";
            startWakeListener();
          }
        };

        mediaRecorder.start();
        document.getElementById("status").innerText = "🎙️ 錄音中...（3 秒無聲自動結束）";
        detectSilence();

      } catch (err) {
        alert("錄音初始化錯誤：" + err.message);
        isRecording = false;
        startWakeListener();
      }
    }

    // ===== [3] 偵測靜音（3 秒無聲結束錄音） =====
    function detectSilence() {
      const buffer = new Uint8Array(analyser.fftSize);
      let silenceDuration = 0;

      function loop() {
        if (!isRecording) return;
        analyser.getByteTimeDomainData(buffer);
        const max = Math.max(...buffer.map(v => Math.abs(v - 128)));

        if (max < 20) silenceDuration += 0.1;
        else silenceDuration = 0;

        if (silenceDuration >= 3 && mediaRecorder && mediaRecorder.state === "recording") {
          document.getElementById("status").innerText = "🛑 偵測到 3 秒無聲，自動結束錄音";
          mediaRecorder.stop();
          return;
        }
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
    }
  </script>
</body>
</html>
