<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>èªéŸ³äº’å‹• AI åŠ©ç†</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    input { padding: 8px; margin: 5px; width: 250px; }
    #status { margin-top: 20px; font-size: 18px; color: #444; }
  </style>
</head>
<body>
  <h2>ğŸ¤– èªéŸ³äº’å‹• AI åŠ©ç†</h2>
  <p>è¼¸å…¥ä½ çš„ AI åç¨±èˆ‡ n8n Webhook ç¶²å€ï¼š</p>
  <input id="aiName" placeholder="AI åç¨± (ä¾‹å¦‚ å°æ™º1)" /><br>
  <input id="webhookUrl" placeholder="n8n Webhook URL" /><br>
  <button onclick="startWakeListener()">å•Ÿå‹•èªéŸ³ç›£è½</button>
  <p id="status">å°šæœªå•Ÿå‹•</p>

  <script>
    let aiName = "";
    let n8nUrl = "";
    let mediaRecorder;
    let audioChunks = [];
    let audioContext, analyser, source;

    let rec; // å…¨åŸŸä¿å­˜ SpeechRecognition å¯¦ä¾‹

    // ===== [1] å•Ÿå‹•èªéŸ³å–šé†’ç›£è½ =====
    function startWakeListener() {
      aiName = document.getElementById("aiName").value.trim();
      n8nUrl = document.getElementById("webhookUrl").value.trim();

      if (!aiName || !n8nUrl) {
        alert("è«‹è¼¸å…¥ AI åç¨±èˆ‡ Webhook URLï¼");
        return;
      }

      // è‹¥å·²æœ‰è¾¨è­˜å™¨ï¼Œå…ˆä¸­æ­¢é¿å…é‡è¤‡
      if (rec) rec.abort();

      rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      rec.lang = 'zh';
      rec.continuous = true;
      rec.interimResults = false;

      rec.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.trim();
        console.log("ğŸ§ åµæ¸¬åˆ°èªéŸ³:", transcript);
        document.getElementById("status").innerText = "è½åˆ°: " + transcript;

        // è‹¥åµæ¸¬åˆ° AI åç¨± â†’ åœæ­¢ç›£è½ä¸¦é–‹å§‹éŒ„éŸ³
        if (transcript.includes(aiName)) {
          document.getElementById("status").innerText = `âœ… å–šé†’ã€Œ${aiName}ã€æˆåŠŸï¼Œé–‹å§‹éŒ„éŸ³ï¼`;
          rec.stop(); // æš«åœå–šé†’ç›£è½
          startMainRecording(); // é€²å…¥éŒ„éŸ³éšæ®µ
        }
      };

      rec.onerror = (err) => console.error("å–šé†’éŒ¯èª¤:", err);
      rec.onend = () => {
        console.log("å–šé†’ç›£è½çµæŸï¼Œé‡æ–°å•Ÿå‹•...");
        setTimeout(() => rec.start(), 1000);
      };

      rec.start();
      document.getElementById("status").innerText = "ğŸ¤ å·²å•Ÿå‹•å–šé†’ç›£è½...";
    }

    // ===== [2] éŒ„éŸ³éšæ®µ =====
async function startMainRecording() {
  // âœ… é—œé–‰èªéŸ³è¾¨è­˜ï¼Œé‡‹æ”¾éº¥å…‹é¢¨
  if (rec && rec.stop) {
    try { rec.stop(); } catch (e) { console.warn("ç„¡æ³•åœæ­¢èªéŸ³ç›£è½:", e); }
  }

  // âœ… ç­‰ 0.5 ç§’å†å•Ÿå‹•éŒ„éŸ³ï¼Œç¢ºä¿éº¥å…‹é¢¨é‡‹æ”¾å®Œæˆ
  await new Promise(r => setTimeout(r, 500));

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  // âœ… å¼·åˆ¶ä½¿ç”¨ opus ç·¨ç¢¼
  mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm;codecs=opus" });

  audioChunks = [];
  mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

  mediaRecorder.onstop = async () => {
    const blob = new Blob(audioChunks, { type: "audio/webm" });
    console.log("éŒ„éŸ³å¤§å°:", blob.size, "bytes");
    const formData = new FormData();
    formData.append("file", blob, "voice.webm");

    document.getElementById("status").innerText = "ğŸ“¤ å‚³é€éŒ„éŸ³ä¸­...";
    const res = await fetch(n8nUrl, { method: "POST", body: formData });
    const result = await res.json();
    console.log("ä¼ºæœå™¨å›å‚³:", result);
  };

  mediaRecorder.start();
  document.getElementById("status").innerText = "ğŸ™ï¸ éŒ„éŸ³ä¸­...(3 ç§’ç„¡è²è‡ªå‹•çµæŸ)";
  detectSilence();
}

    // ===== [3] åµæ¸¬éœéŸ³çµæŸ =====
    function detectSilence() {
      const buffer = new Uint8Array(analyser.fftSize);
      let silenceDuration = 0;

      function loop() {
        analyser.getByteTimeDomainData(buffer);
        let max = Math.max(...buffer.map(v => Math.abs(v - 128)));

        if (max < 20) { // éœéŸ³é–¾å€¼
          silenceDuration += 0.1;
        } else {
          silenceDuration = 0;
        }

        if (silenceDuration >= 3 && mediaRecorder && mediaRecorder.state === "recording") {
          document.getElementById("status").innerText = "ğŸ›‘ åµæ¸¬åˆ° 3 ç§’ç„¡è²ï¼Œè‡ªå‹•çµæŸéŒ„éŸ³";
          mediaRecorder.stop();
          return;
        }

        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
    }
  </script>
</body>
</html>



