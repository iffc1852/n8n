<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>語音互動 AI 助理（穩定版）</title>
<style>
  body { font-family:sans-serif;text-align:center;margin-top:40px; }
  input,button{padding:8px;margin:5px;}
  #status{margin-top:20px;font-size:18px;}
  #meterContainer{width:300px;height:20px;background:#ddd;border-radius:10px;margin:20px auto;overflow:hidden;display:none;}
  #meterBar{height:100%;width:0%;background:linear-gradient(to right,#4CAF50,#FFEB3B,#F44336);transition:width 0.05s;}
</style>
</head>
<body>
<h2>🤖 語音互動 AI 助理（穩定錄音版）</h2>
<input id="aiName" placeholder="AI 名稱 (例如 小智)" /><br>
<input id="webhookUrl" placeholder="n8n Webhook URL" /><br>
<button id="startBtn">啟動語音監聽</button>
<div id="meterContainer"><div id="meterBar"></div></div>
<p id="status">尚未啟動</p>

<script>
let aiName="", n8nUrl="", rec, mediaRecorder;
let audioChunks=[], audioContext, analyser, source;
let isRecording=false, meterBar=document.getElementById("meterBar"), meterContainer=document.getElementById("meterContainer");

document.getElementById("startBtn").addEventListener("click",async()=>{
  aiName=document.getElementById("aiName").value.trim();
  n8nUrl=document.getElementById("webhookUrl").value.trim();
  if(!aiName||!n8nUrl){alert("請輸入 AI 名稱與 Webhook URL！");return;}
  await navigator.mediaDevices.getUserMedia({audio:true}); // 要求權限
  startWakeListener();
});

function startWakeListener(){
  if(rec) try{rec.abort();}catch{}
  rec=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
  rec.lang="zh-TW"; rec.continuous=true; rec.interimResults=false;

  rec.onstart=()=>{document.getElementById("status").innerText="🎧 已啟動喚醒（說出 AI 名稱）";};
  rec.onresult=(e)=>{
    const txt=e.results[e.results.length-1][0].transcript.trim();
    console.log("聽到:",txt);
    if(txt.includes(aiName)){
      document.getElementById("status").innerText=`✅ 偵測到「${aiName}」，準備錄音...`;
      rec.abort(); // ⚠️ 完全中斷辨識，釋放音源
      setTimeout(startMainRecording,1000); // 延遲 1 秒啟動錄音
    }
  };
  rec.onerror=(err)=>console.warn("喚醒錯誤:",err);
  rec.onend=()=>{ if(!isRecording) setTimeout(()=>rec.start(),1000); };
  rec.start();
}

// ===== 錄音階段 =====
async function startMainRecording(){
  isRecording=true;
  meterContainer.style.display="block";
  document.getElementById("status").innerText="🎙️ 正在錄音...";
  try{
    // ✅ 重新開啟全新音源，避免 SpeechRecognition 的舊流
    const stream=await navigator.mediaDevices.getUserMedia({
      audio:{ echoCancellation:true, noiseSuppression:true, channelCount:1 }
    });

    mediaRecorder=new MediaRecorder(stream,{mimeType:"audio/webm;codecs=opus"});
    audioChunks=[];
    audioContext=new AudioContext();
    source=audioContext.createMediaStreamSource(stream);
    analyser=audioContext.createAnalyser();
    analyser.fftSize=2048;
    source.connect(analyser);

    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=async()=>{
      isRecording=false; meterContainer.style.display="none";
      const blob=new Blob(audioChunks,{type:"audio/webm"});
      console.log("錄音大小:",blob.size,"bytes");
      if(blob.size<1500){document.getElementById("status").innerText="⚠️ 沒錄到聲音，回到監聽...";startWakeListener();return;}
      const formData=new FormData(); formData.append("file",blob,"voice.webm");
      document.getElementById("status").innerText="📤 上傳中...";
      try{
        const res=await fetch(n8nUrl,{method:"POST",body:formData});
        const result=await res.json();
        if(result.success&&result.audio){
          const audio=new Audio("data:audio/mp3;base64,"+result.audio);
          audio.play();
          document.getElementById("status").innerText="🔊 播放回覆中...";
          audio.onended=()=>{document.getElementById("status").innerText="🎧 回到喚醒模式";startWakeListener();};
        }else{document.getElementById("status").innerText="⚠️ 回傳錯誤";startWakeListener();}
      }catch(err){console.error(err);document.getElementById("status").innerText="❌ 上傳失敗";startWakeListener();}
    };

    mediaRecorder.start();
    detectSilenceAndVisualize();
  }catch(err){
    console.error("錄音錯誤:",err);
    isRecording=false; meterContainer.style.display="none"; startWakeListener();
  }
}

// ===== 靜音偵測 + 音量條 =====
function detectSilenceAndVisualize(){
  const buffer=new Uint8Array(analyser.fftSize);
  let silenceDuration=0;
  function loop(){
    if(!isRecording)return;
    analyser.getByteTimeDomainData(buffer);
    const max=Math.max(...buffer.map(v=>Math.abs(v-128)));
    const volume=Math.min(100,max*1.2);
    meterBar.style.width=volume+"%";
    if(max<20)silenceDuration+=0.1; else silenceDuration=0;
    if(silenceDuration>=3&&mediaRecorder&&mediaRecorder.state==="recording"){
      document.getElementById("status").innerText="🛑 偵測到 3 秒無聲，自動結束";
      mediaRecorder.stop(); return;
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
